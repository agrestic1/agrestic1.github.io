<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.1" /><meta property="og:title" content="Traefik loadbalancer with crowdsec Open Source &amp; Collaborative Security" /><meta property="og:locale" content="en" /><meta name="description" content="We’re going to use SSL for everything. No more self-sign certs. No more http. No more hosting things on odd ports. We’re going all in with SSL for our external services. We going to set up a reverse proxy using Traefik, Portainer, and use that to get certificates from Let’s Encrypt." /><meta property="og:description" content="We’re going to use SSL for everything. No more self-sign certs. No more http. No more hosting things on odd ports. We’re going all in with SSL for our external services. We going to set up a reverse proxy using Traefik, Portainer, and use that to get certificates from Let’s Encrypt." /><link rel="canonical" href="https://agrestic1.github.io/posts/traefik/" /><meta property="og:url" content="https://agrestic1.github.io/posts/traefik/" /><meta property="og:site_name" content="Agrestic Doku" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-07T11:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Traefik loadbalancer with crowdsec Open Source &amp; Collaborative Security" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-12-30T23:31:51+01:00","datePublished":"2022-06-07T11:00:00+02:00","description":"We’re going to use SSL for everything. No more self-sign certs. No more http. No more hosting things on odd ports. We’re going all in with SSL for our external services. We going to set up a reverse proxy using Traefik, Portainer, and use that to get certificates from Let’s Encrypt.","headline":"Traefik loadbalancer with crowdsec Open Source &amp; Collaborative Security","mainEntityOfPage":{"@type":"WebPage","@id":"https://agrestic1.github.io/posts/traefik/"},"url":"https://agrestic1.github.io/posts/traefik/"}</script><title>Traefik loadbalancer with crowdsec Open Source & Collaborative Security | Agrestic Doku</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Agrestic Doku"><meta name="application-name" content="Agrestic Doku"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> </a></div><div class="site-title"> <a href="/">Agrestic Doku</a></div><div class="site-subtitle font-italic">A Doc site for my homelab</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/agrestic1" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Traefik loadbalancer with crowdsec Open Source & Collaborative Security</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Traefik loadbalancer with crowdsec Open Source & Collaborative Security</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1654592400" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jun 7, 2022 </em> </span> <span> Updated <em class="" data-ts="1672439511" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Dec 30, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/agrestic1">agrestic</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2071 words"> <em>11 min</em> read</span></div></div></div><div class="post-content"><p>We’re going to use SSL for everything. No more self-sign certs. No more http. No more hosting things on odd ports. We’re going all in with SSL for our external services. We going to set up a reverse proxy using Traefik, Portainer, and use that to get certificates from Let’s Encrypt.</p><h2 id="quellen"><span class="mr-2">Quellen</span><a href="#quellen" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://www.youtube.com/watch?v=liV3c9m_OX8">Techno Tim traefik Youtube</a></p><p><a href="https://techno-tim.github.io/posts/traefik-portainer-ssl">Techno Tim traefik doku</a></p><p><a href="https://www.youtube.com/watch?v=wLrmmh1eI94">The digital life traefik youtube</a></p><p><a href="https://github.com/xcad2k/boilerplates/tree/main/docker-compose/traefik">The digital life traefik doku</a></p><p><a href="https://www.youtube.com/watch?v=-GxUP6bNxF0">Techno Tim crowdsec Youtube</a></p><p><a href="https://docs.technotim.live/posts/crowdsec-traefik/">Techno Tim crowdsec doku</a></p><p><a href="https://www.himpler.com/blog/network-mode-host-mit-traefik/">Pihole im Hostnet</a></p><h2 id="docker-setup"><span class="mr-2">Docker Setup</span><a href="#docker-setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>See <a href="https://agrestic1.github.io/posts/docker/">this post</a> on how to install <code class="language-plaintext highlighter-rouge">docker</code> and <code class="language-plaintext highlighter-rouge">docker-compose</code></p><h2 id="traefik"><span class="mr-2">Traefik</span><a href="#traefik" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>SSH into Synology</p><p>Create the folder structure and necessary files. <code class="language-plaintext highlighter-rouge">acme.json</code> will store the SSL certificates</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nb">cd</span> /volume1/docker/
<span class="nb">mkdir</span> <span class="nt">-p</span> traefik/data <span class="o">&amp;&amp;</span> <span class="nb">cd </span>traefik/data
<span class="nb">touch </span>acme.json
<span class="nb">chmod </span>600 acme.json
<span class="nb">touch </span>traefik.yml
vi traefik.yml
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">traefik.yml</code> Contains the static configuration for traefik. Changese here need a restart of the traefik container</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre><td class="rouge-code"><pre><span class="na">global</span><span class="pi">:</span>
  <span class="na">checkNewVersion</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">sendAnonymousUsage</span><span class="pi">:</span> <span class="no">false</span>  <span class="c1"># true by default</span>

<span class="c1"># Log information; necessary for crowdsec</span>
<span class="na">log</span><span class="pi">:</span>
  <span class="na">level</span><span class="pi">:</span> <span class="s2">"</span><span class="s">INFO"</span>  <span class="c1"># DEBUG, INFO, WARNING, ERROR, CRITICAL</span>
  <span class="na">filePath</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/var/log/traefik/traefik.log"</span>
<span class="c1">#   format: common  # common, json, logfmt</span>

<span class="c1"># Accesslog; necessary for crowdsec</span>
<span class="na">accessLog</span><span class="pi">:</span>
  <span class="na">filePath</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/var/log/traefik/access.log"</span>
  <span class="c1"># format: common  # common, json, logfmt</span>

<span class="c1"># (Optional) Enable API and Dashboard</span>
<span class="na">api</span><span class="pi">:</span>
 <span class="na">dashboard</span><span class="pi">:</span> <span class="no">true</span>  <span class="c1"># true by default</span>
 <span class="na">insecure</span><span class="pi">:</span> <span class="no">true</span>  <span class="c1"># Don't do this in production!</span>

<span class="c1"># Entry Points configuration</span>
<span class="na">entryPoints</span><span class="pi">:</span>
  <span class="na">web</span><span class="pi">:</span>
    <span class="na">address</span><span class="pi">:</span> <span class="s">:80</span>
    <span class="c1"># Apply crowdsec-bouncer middleware to everything also docker services (crowdsec-bouncer middleware defined in dynamic.yml)</span>
    <span class="na">http</span><span class="pi">:</span>
      <span class="na">middlewares</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">crowdsec-bouncer@file</span>
    <span class="c1"># (Optional) Redirect to HTTPS, we don't do that here, but individually</span>
    <span class="c1"># http:</span>
    <span class="c1">#   redirections:</span>
    <span class="c1">#     entryPoint:</span>
    <span class="c1">#       to: websecure</span>
    <span class="c1">#       scheme: https</span>

  <span class="na">websecure</span><span class="pi">:</span>
    <span class="na">address</span><span class="pi">:</span> <span class="s">:443</span>
    <span class="c1"># Apply crowdsec-bouncer middleware</span>
    <span class="na">http</span><span class="pi">:</span>
      <span class="na">middlewares</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">crowdsec-bouncer@file</span>

<span class="c1"># Configure your CertificateResolvers here</span>
<span class="na">certificatesResolvers</span><span class="pi">:</span>
  <span class="na">staging</span><span class="pi">:</span>
    <span class="na">acme</span><span class="pi">:</span>
      <span class="na">email</span><span class="pi">:</span> <span class="s">rettichmann@live.de</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="s">/etc/traefik/acme.json</span>
      <span class="na">caServer</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://acme-staging-v02.api.letsencrypt.org/directory"</span>
      <span class="na">httpChallenge</span><span class="pi">:</span>
        <span class="na">entryPoint</span><span class="pi">:</span> <span class="s">web</span>
  <span class="na">production</span><span class="pi">:</span>
    <span class="na">acme</span><span class="pi">:</span>
      <span class="na">email</span><span class="pi">:</span> <span class="s">rettichmann@live.de</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="s">/etc/traefik/acme.json</span>
      <span class="na">caServer</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://acme-v02.api.letsencrypt.org/directory"</span>
      <span class="na">httpChallenge</span><span class="pi">:</span>
        <span class="na">entryPoint</span><span class="pi">:</span> <span class="s">web</span>
  <span class="na">cloudflare</span><span class="pi">:</span>
    <span class="na">acme</span><span class="pi">:</span>
      <span class="na">email</span><span class="pi">:</span> <span class="s">rettichmann@live.de</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="s">/etc/traefik/acme.json</span>
      <span class="na">dnsChallenge</span><span class="pi">:</span>
        <span class="na">provider</span><span class="pi">:</span> <span class="s">cloudflare</span>
        <span class="na">delayBeforeCheck</span><span class="pi">:</span> <span class="m">0</span>
        <span class="na">resolvers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">1.1.1.1:53</span>
        <span class="pi">-</span> <span class="s">1.0.0.1:53</span>

<span class="na">serversTransport</span><span class="pi">:</span>
    <span class="na">insecureSkipVerify</span><span class="pi">:</span> <span class="no">true</span> <span class="c1"># Accept serlf signed certs from e.g. DSM</span>

<span class="na">providers</span><span class="pi">:</span>
  <span class="na">docker</span><span class="pi">:</span>
    <span class="na">exposedByDefault</span><span class="pi">:</span> <span class="no">false</span>  <span class="c1"># Default is true, if false containers need label "traefik.enable=true" to be exposed</span>
  <span class="na">file</span><span class="pi">:</span>
    <span class="c1"># watch for dynamic configuration changes</span>
    <span class="na">directory</span><span class="pi">:</span> <span class="s">/etc/traefik</span>
    <span class="na">watch</span><span class="pi">:</span> <span class="no">true</span>
</pre></table></code></div></div><h4 id="enviroment-variables"><span class="mr-2">Enviroment variables</span><a href="#enviroment-variables" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>For traefik</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>vi /volume1/docker/portainer/data/compose/traefik.env
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">traefik.env</code></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c"># Necessary for cloudflare SSL certificate</span>
<span class="c"># Needs to go to /volume1/docker/portainer/data/compose, so that portainer can see it</span>
<span class="c"># referenced in compose with /data/compose/traefik.env</span>
<span class="nv">CF_API_EMAIL</span><span class="o">=</span>rettichmann@live.de
<span class="nv">CF_DNS_API_TOKEN</span><span class="o">=</span>XXXXXXXXXXXXXXXXXXX
</pre></table></code></div></div><h3 id="traefik-routes-config"><span class="mr-2">Traefik Routes Config</span><a href="#traefik-routes-config" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">cd </span>data
<span class="nb">touch </span>dynamic.yml
vi dynamic.yml
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">dynamic.yml</code> Contains the dynamic configuration for traefik. Changese here don’t need a restart of the traefik container</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
</pre><td class="rouge-code"><pre><span class="na">http</span><span class="pi">:</span>
<span class="c1"># ------ Routers --------</span>
  <span class="na">routers</span><span class="pi">:</span>
    <span class="na">dsm-insec</span><span class="pi">:</span>
      <span class="na">entryPoints</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">web</span>
      <span class="na">rule</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Host(`dsm.onehumanwasted.de`)</span><span class="nv"> </span><span class="s">||</span><span class="nv"> </span><span class="s">Host(`nasty.onehumanwasted.de`)"</span>
      <span class="na">middlewares</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">https-redirect</span> <span class="c1"># Leitet auf port 443 um, erzwingt also SSL für den externen traffik</span>
      <span class="c1">#service: service-dsm #SSL auch für internen trafic (mit DSM's self-signed certificate, daher muss serversTransport: insecureSkipVerify: true sein)</span>
      <span class="na">service</span><span class="pi">:</span> <span class="s">service-dsm-insec</span> <span class="c1"># Funktioniert nicht, wenn in DSM ein HTTPS redirect eingestellt ist, denn dann wird auf https://nasty.onehumanwasted.de:2087/ weitergeleitet und Port 2087 ist extern nicht offen</span>
      <span class="c1">#tls:</span>
      <span class="c1">#  certResolver: production</span>
    <span class="na">dsm</span><span class="pi">:</span>
      <span class="na">entryPoints</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">websecure</span>
      <span class="na">rule</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Host(`dsm.onehumanwasted.de`)</span><span class="nv"> </span><span class="s">||</span><span class="nv"> </span><span class="s">Host(`nasty.onehumanwasted.de`)"</span>
      <span class="na">service</span><span class="pi">:</span> <span class="s">service-dsm-insec</span> <span class="c1"># Kommunikation nach proxy ohne SSL, spart recourcen. In DSM darf HTTPS redirect nicht eingestellt sein</span>
      <span class="na">tls</span><span class="pi">:</span>
        <span class="na">certResolver</span><span class="pi">:</span> <span class="s">cloudflare</span>
    <span class="c1"># Nextcloud, falls traefik nicht auf dem selben Endgeraet laeuft und damit nicht ueber docker labels konfigurierbar</span>
    <span class="na">nextcloud-insec</span><span class="pi">:</span>
      <span class="na">entryPoints</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">web</span>
      <span class="na">rule</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Host(`nextcloud.onehumanwasted.de`)"</span>
      <span class="na">middlewares</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">https-redirect</span> <span class="c1"># Leitet auf port 443 um, erzwingt also SSL für den externen traffik</span>
        <span class="pi">-</span> <span class="s">default-headers</span>
      <span class="na">service</span><span class="pi">:</span> <span class="s">service-nextcloud</span>
      <span class="na">tls</span><span class="pi">:</span>
        <span class="na">certResolver</span><span class="pi">:</span> <span class="s">cloudflare</span>
    <span class="na">nextcloud</span><span class="pi">:</span>
      <span class="na">entryPoints</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">websecure</span>
      <span class="na">rule</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Host(`nextcloud.onehumanwasted.de`)"</span>
      <span class="na">middlewares</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">default-headers</span>
      <span class="na">service</span><span class="pi">:</span> <span class="s">service-nextcloud</span>
      <span class="na">tls</span><span class="pi">:</span>
        <span class="na">certResolver</span><span class="pi">:</span> <span class="s">cloudflare</span>


<span class="c1"># ------ Services --------</span>
  <span class="na">services</span><span class="pi">:</span>
    <span class="na">service-dsm</span><span class="pi">:</span>
      <span class="na">loadBalancer</span><span class="pi">:</span>
        <span class="na">passHostHeader</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">servers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://192.168.178.75:2087"</span>
    <span class="na">service-dsm-insec</span><span class="pi">:</span> <span class="c1"># Nicht noetig fuer Synology Letsencrypt Zertifikat Erneuerung</span>
      <span class="na">loadBalancer</span><span class="pi">:</span>
        <span class="na">passHostHeader</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">servers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">http://192.168.178.75:5000"</span>
    <span class="na">service-nextcloud</span><span class="pi">:</span> <span class="c1">#Nextcloud @ Synology</span>
      <span class="na">loadBalancer</span><span class="pi">:</span>
        <span class="na">passHostHeader</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">servers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">url</span><span class="pi">:</span> <span class="s2">"</span><span class="s">http://192.168.178.75:8082"</span>


<span class="c1"># ------ Middlewares --------</span>
  <span class="na">middlewares</span><span class="pi">:</span>
<span class="c1"># Declaring the user list</span>
<span class="c1">#    test-auth:</span>
<span class="c1">#      basicAuth:</span>
<span class="c1">#        users:</span>
<span class="c1">#          - "Martin:XXXXXXXXXXXXXXX"</span>
    <span class="na">https-redirect</span><span class="pi">:</span>
      <span class="na">redirectscheme</span><span class="pi">:</span>
        <span class="na">scheme</span><span class="pi">:</span> <span class="s">https</span>

    <span class="na">crowdsec-bouncer</span><span class="pi">:</span>
      <span class="na">forwardauth</span><span class="pi">:</span>
        <span class="na">address</span><span class="pi">:</span> <span class="s">http://bouncer-traefik:8080/api/v1/forwardAuth</span>
        <span class="na">trustForwardHeader</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">default-headers</span><span class="pi">:</span>
      <span class="na">headers</span><span class="pi">:</span>
        <span class="na">frameDeny</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">browserXssFilter</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">contentTypeNosniff</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">forceSTSHeader</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">stsIncludeSubdomains</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">stsPreload</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">stsSeconds</span><span class="pi">:</span> <span class="m">15552000</span>
        <span class="na">customFrameOptionsValue</span><span class="pi">:</span> <span class="s">SAMEORIGIN</span>
        <span class="na">customRequestHeaders</span><span class="pi">:</span>
          <span class="na">X-Forwarded-Proto</span><span class="pi">:</span> <span class="s">https</span>
</pre></table></code></div></div><h3 id="create-traefik-network"><span class="mr-2">Create traefik network</span><a href="#create-traefik-network" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Hint: This needs to be executed after setting up Synology, even before installing portainer. It can be a sheduled task to run once as root with the following content.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker network create traefik_default
</pre></table></code></div></div><h2 id="crowdsec"><span class="mr-2">Crowdsec</span><a href="#crowdsec" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nb">cd</span> /volume1/docker/
<span class="nb">mkdir</span> <span class="nt">-p</span> crowdsec/data
<span class="nb">cd </span>crowdsec
<span class="nb">mkdir </span>config <span class="o">&amp;&amp;</span> <span class="nb">cd </span>config

<span class="nb">touch </span>acquis.yaml
vi acquis.yaml
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">acquis.yaml</code> Tells crowdsec where the logs are and of what kind they are (labeled as traefik)</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="na">filenames</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">/var/log/traefik/*</span>
<span class="na">labels</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">traefik</span>
</pre></table></code></div></div><h4 id="enviroment-variables-1"><span class="mr-2">Enviroment variables</span><a href="#enviroment-variables-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>For crowdsec</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>vi /volume1/docker/portainer/data/compose/crowdsec.env
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">crowdsec.env</code></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c"># Needs to go to /volume1/docker/portainer/data/compose, so that portainer can see it</span>
<span class="c"># referenced in compose with /data/compose/crowdsec.env</span>
<span class="nv">CROWDSEC_BOUNCER_API_KEY</span><span class="o">=</span>XXXXXXXXXX
</pre></table></code></div></div><h2 id="docker-compose"><span class="mr-2">Docker compose</span><a href="#docker-compose" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">cd</span> /volume1/docker/traefik/
<span class="nb">touch </span>docker-compose.yml
vi docker-compose.yml
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">docker-compose.yml</code></p><div class="language-yml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
</pre><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">traefik</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s2">"</span><span class="s">traefik:latest"</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">traefik"</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">80:80"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">443:443"</span>
      <span class="c1"># (Optional) Expose Dashboard</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">8080:8080"</span>  <span class="c1"># Don't do this in production!</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/etc/localtime:/etc/localtime:ro</span>
      <span class="pi">-</span> <span class="s">/volume1/docker/traefik/data:/etc/traefik</span>
      <span class="pi">-</span> <span class="s">/var/run/docker.sock:/var/run/docker.sock:ro</span>
      <span class="pi">-</span> <span class="s">/volume1/docker/traefik/logs:/var/log/traefik</span> <span class="c1"># For crowdsec</span>
    <span class="c1"># environment:</span>
      <span class="c1"># - CF_API_EMAIL= xxx</span>
      <span class="c1"># API Token for the zone</span>
      <span class="c1"># - CF_DNS_API_TOKEN= xxx # -&gt; /volume1/docker/portainer/data/compose/traefik.env</span>
    <span class="na">env_file</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/data/compose/traefik.env</span> <span class="c1"># Needs to be in /volume1/docker/portainer/data/compose, so that portainer can see it</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="c1">## Traefik</span>
      <span class="c1"># - "traefik.enable=true" # Muss an bleiben, sonst funktioniert middlewares.https-redirect@docker nicht</span>
      <span class="c1"># Http (Cloudlfare HTTPS redirect only works for main domain)</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.routers.traefik_insec.entrypoints=web"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.routers.traefik_insec.rule=Host(`traefik.onehumanwasted.de`)"</span>
      <span class="c1"># HTTPS redirection</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.middlewares.traefik-https-redirect.redirectscheme.scheme=https"</span> <span class="c1"># Create a middleware named traefik-https-redirect</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.routers.traefik_insec.middlewares=traefik-https-redirect"</span> <span class="c1"># Apply the middleware named `traefik-https-redirect` to the router named `traefik_insec`</span>
      <span class="c1"># HTTPS</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.routers.traefik.entrypoints=websecure"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.routers.traefik.rule=Host(`traefik.onehumanwasted.de`)"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.routers.traefik.tls=true"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.routers.traefik.tls.certresolver=production"</span>
      <span class="c1"># Authentication</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.middlewares.traefik-auth.digestauth.users=Martin:traefik:XXXXXXXXXXXX"</span> <span class="c1"># Create a middleware</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.routers.traefik.middlewares=traefik-auth"</span> <span class="c1"># Apply the middleware</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik.http.routers.traefik.service=api@internal"</span>
      <span class="c1">## Watchtower</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">com.centurylinklabs.watchtower.enable=true"</span>
    <span class="c1">#extra_hosts:</span>
    <span class="c1">#  - host.docker.internal:172.17.0.1 # Damit auch pihole im Hostnet gefunden wird</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">traefik_default"</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>

  <span class="na">crowdsec</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">crowdsecurity/crowdsec:latest</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">crowdsec</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">GID</span><span class="pi">:</span> <span class="s2">"</span><span class="s">${GID-1000}"</span>
      <span class="na">COLLECTIONS</span><span class="pi">:</span> <span class="s2">"</span><span class="s">crowdsecurity/linux</span><span class="nv"> </span><span class="s">crowdsecurity/traefik"</span>
    <span class="na">depends_on</span><span class="pi">:</span>  <span class="c1">#uncomment if running traefik in the same compose file</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">traefik'</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="c1"># - ./config/acquis.yaml:/etc/crowdsec/acquis.yaml</span>
      <span class="pi">-</span> <span class="s">/volume1/docker/crowdsec/acquis.yaml:/etc/crowdsec/acquis.yaml</span>
      <span class="c1"># - crowdsec-db:/var/lib/crowdsec/data/</span>
      <span class="pi">-</span> <span class="s">/volume1/docker/crowdsec/data:/var/lib/crowdsec/data/</span>
      <span class="pi">-</span> <span class="s">crowdsec-config:/etc/crowdsec/</span>
      <span class="c1">#- /volume1/docker/crowdsec/config:/etc/crowdsec/ # for some reason this does not work, needs to be a docker volume</span>
      <span class="c1"># - traefik_traefik-logs:/var/log/traefik/:ro</span>
      <span class="pi">-</span> <span class="s">/volume1/docker/traefik/logs:/var/log/traefik/:ro</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">traefik_default</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">com.centurylinklabs.watchtower.enable=true"</span>

  <span class="na">bouncer-traefik</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.io/fbonalair/traefik-crowdsec-bouncer:latest</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">bouncer-traefik</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="c1"># Get api key with "docker exec crowdsec cscli bouncers add bouncer-traefik" and save it to crowdsec.env</span>
      <span class="c1"># CROWDSEC_BOUNCER_API_KEY: some-api-key # is now in crowdsec.env</span>
      <span class="na">CROWDSEC_AGENT_HOST</span><span class="pi">:</span> <span class="s">crowdsec:8080</span>
    <span class="na">env_file</span><span class="pi">:</span>
       <span class="pi">-</span> <span class="s">/data/compose/crowdsec.env</span> <span class="c1"># Needs to be in /volume1/docker/portainer/data/compose, so that portainer can see it</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">traefik_default</span> <span class="c1"># same network as traefik + crowdsec</span>
    <span class="na">depends_on</span><span class="pi">:</span> <span class="c1"># don't start until crowdsec is not started</span>
      <span class="pi">-</span> <span class="s">crowdsec</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">com.centurylinklabs.watchtower.enable=true"</span>

<span class="na">volumes</span><span class="pi">:</span>
  <span class="c1">#crowdsec-db:</span>
  <span class="na">crowdsec-config</span><span class="pi">:</span>
  <span class="c1">#traefik_traefik-logs: # this will be the name of the volume from trarfic logs</span>
    <span class="c1">#external: true # remove if traefik is running on same stack</span>
      
<span class="na">networks</span><span class="pi">:</span>
  <span class="na">traefik_default</span><span class="pi">:</span>
    <span class="na">external</span><span class="pi">:</span> <span class="no">true</span> <span class="c1"># Join the existing network, created with portainer</span>
<span class="c1"># Create network</span>
<span class="c1">#networks:</span>
<span class="c1">#  network-traefik:</span>
<span class="c1">#    name: "traefik_default"</span>
<span class="c1">#    driver: bridge</span>
<span class="c1">#   ipam:</span>
<span class="c1">#      driver: default</span>
</pre></table></code></div></div><p>Your folder structure should look like the below, if you are following along with the example. But feel free to make it however you wish just keep in mind you’ll need to change the location in the corresponding files.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>./traefik
├── data
│   ├── acme.json
│   ├── dynamic.yml
│   └── traefik.yml
└── docker-compose.yml
</pre></table></code></div></div><h2 id="spin-up-the-container"><span class="mr-2">Spin up the container</span><a href="#spin-up-the-container" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>…using docker-compose, better use a Portainer stack!</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker-compose up <span class="nt">-d</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker-compose up <span class="nt">-d</span> <span class="nt">--force-recreate</span>
</pre></table></code></div></div><h2 id="generate-auth-password-to-protect-the-traefik-dashboard"><span class="mr-2">Generate Auth Password, to protect the traefik dashboard</span><a href="#generate-auth-password-to-protect-the-traefik-dashboard" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>On another (any) Linux machine do:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt <span class="nb">install </span>apache2-utils
</pre></table></code></div></div><h3 id="basic-auth"><span class="mr-2">Basic auth</span><a href="#basic-auth" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Basic auth uses non-encrypted base64 encoding. Therefore, Basic Authentication should generally only be used where transport layer security is provided such as https.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">echo</span> <span class="si">$(</span>htpasswd <span class="nt">-nb</span> &lt;USER&gt; &lt;PASSWORD&gt;<span class="si">)</span> | <span class="nb">sed</span> <span class="nt">-e</span> s/<span class="se">\\</span><span class="nv">$/</span><span class="se">\\</span><span class="nv">$\</span><span class="se">\$</span>/g
</pre></table></code></div></div><p>NOTE: Replace <code class="language-plaintext highlighter-rouge">&lt;USER&gt;</code> with your username and <code class="language-plaintext highlighter-rouge">&lt;PASSWORD&gt;</code> with your password to be hashed.</p><p>Paste the output in your <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> in line (<code class="language-plaintext highlighter-rouge">traefik.http.middlewares.traefik-auth.basicauth.users=&lt;USER&gt;:&lt;HASHED-PASSWORD&gt;</code>)</p><h3 id="digest-auth"><span class="mr-2">Digest auth</span><a href="#digest-auth" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>htdigest <span class="nt">-c</span> pwdfile traefik &lt;USER&gt; <span class="o">&amp;&amp;</span> <span class="nb">cat </span>pwdfile
</pre></table></code></div></div><p>NOTE: Replace <code class="language-plaintext highlighter-rouge">&lt;USER&gt;</code> with your username and <code class="language-plaintext highlighter-rouge">&lt;PASSWORD&gt;</code> with your password to be hashed. Paste the output in your <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> in line (traefik.http.middlewares.traefik-auth.digest.users=<code class="language-plaintext highlighter-rouge">&lt;USER&gt;</code>:traefik:<code class="language-plaintext highlighter-rouge">&lt;HASHED-PASSWORD&gt;</code>)</p><h2 id="anleitung-um-traefik-mit-crowdsec-zu-konfigurieren-bereits-in-yml-und-docker-compose-umgesetzt"><span class="mr-2">Anleitung um traefik mit crowdsec zu konfigurieren (bereits in yml und docker-compose umgesetzt):</span><a href="#anleitung-um-traefik-mit-crowdsec-zu-konfigurieren-bereits-in-yml-und-docker-compose-umgesetzt" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">cd</span> ../traefik
<span class="nb">cd </span>data
vi traefik.yml
</pre></table></code></div></div><p>Adjustments for crowdsec in <code class="language-plaintext highlighter-rouge">traefik.yml</code></p><div class="language-yml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="s">// check to be sure you have your middleware set for both</span>
<span class="na">entryPoints</span><span class="pi">:</span>
  <span class="na">web</span><span class="pi">:</span>
    <span class="na">address</span><span class="pi">:</span> <span class="s2">"</span><span class="s">:80"</span>
    <span class="c1"># Apply crowdsec-bouncer middleware to everything also docker services (crowdsec-bouncer middleware defined in dynamic.yml)</span>
    <span class="na">http</span><span class="pi">:</span>
      <span class="na">middlewares</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">crowdsec-bouncer@file</span>
  <span class="na">websecure</span><span class="pi">:</span>
    <span class="na">address</span><span class="pi">:</span> <span class="s2">"</span><span class="s">:443"</span>
    <span class="c1"># Apply crowdsec-bouncer middleware</span>
    <span class="na">http</span><span class="pi">:</span>
      <span class="na">middlewares</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">crowdsec-bouncer@file</span>

<span class="na">// at the end add the logging options</span><span class="pi">:</span>
<span class="na">log</span><span class="pi">:</span>
  <span class="na">level</span><span class="pi">:</span> <span class="s2">"</span><span class="s">INFO"</span>
  <span class="na">filePath</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/var/log/traefik/traefik.log"</span>
<span class="na">accessLog</span><span class="pi">:</span>
  <span class="na">filePath</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/var/log/traefik/access.log"</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>vi dynamic.yml
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">dynamic.yml</code></p><div class="language-yml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="s">// in middlewares add crowdsec-bouncer</span>
    <span class="s">crowdsec-bouncer</span><span class="err">:</span>
      <span class="na">forwardauth</span><span class="pi">:</span>
        <span class="na">address</span><span class="pi">:</span> <span class="s">http://bouncer-traefik:8080/api/v1/forwardAuth</span>
        <span class="na">trustForwardHeader</span><span class="pi">:</span> <span class="no">true</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">cd</span> ..
<span class="nb">mkdir </span>logs
vi docker-compose.yml
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">docker-compose.yml</code></p><div class="language-yml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="s">// add volume for logs</span>
    <span class="s">volumes</span><span class="err">:</span>
      <span class="pi">-</span> <span class="s">/volume1/docker/traefik/logs:/var/log/traefik</span> <span class="c1"># For crowdsec</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="c"># Start crowdsec and restart traefik</span>
<span class="c"># see metrics, check if traefik logs are read</span>
docker <span class="nb">exec </span>crowdsec cscli metrics
<span class="c"># must look like this</span>
<span class="c">#Acquisition Metrics:</span>
<span class="c">#+----------------------------------+------------+--------------+----------------</span>
<span class="c">#|              Source              | Lines read | Lines parsed | Lines unparsed</span>
<span class="c">#+----------------------------------+------------+--------------+----------------</span>
<span class="c">#| file:/var/log/traefik/access.log | 58         | 58           | -              </span>
<span class="c">#+----------------------------------+------------+--------------+---------------- </span>
<span class="c"># see bans</span>
docker <span class="nb">exec </span>crowdsec cscli decisions list
<span class="c"># manually install collections</span>
<span class="c"># no need to do that, since we've defined the enviroment variable COLLECTIONS: "crowdsecurity/linux crowdsecurity/traefik" in docker-compose.yml</span>
docker <span class="nb">exec </span>crowdsec cscli collections <span class="nb">install </span>crowdsecurity/traefik
<span class="c"># update hubs</span>
docker <span class="nb">exec </span>crowdsec cscli hub update
<span class="c"># upgrade hubs</span>
docker <span class="nb">exec </span>crowdsec cscli hub upgrade
<span class="c"># add bouncer</span>
<span class="c"># (save api key somewhere and add it to the crowdsec.env file)</span>
docker <span class="nb">exec </span>crowdsec cscli bouncers add bouncer-traefik
<span class="c"># ban ip</span>
docker <span class="nb">exec </span>crowdsec cscli decisions add <span class="nt">--ip</span> 192.168.0.101
<span class="c"># see bans</span>
docker <span class="nb">exec </span>crowdsec cscli decisions list
<span class="c"># unban ip</span>
docker <span class="nb">exec </span>crowdsec cscli decisions delete <span class="nt">--ip</span> 192.168.0.101
</pre></table></code></div></div><h2 id="synology-drive--dsm"><span class="mr-2">Synology Drive / DSM:</span><a href="#synology-drive--dsm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Neuen täglichen Task Sheduler @root um crowdsec täglich upzudaten:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker <span class="nb">exec </span>crowdsec cscli hub update <span class="o">&amp;&amp;</span> docker <span class="nb">exec </span>crowdsec cscli hub upgrade
</pre></table></code></div></div><p>Am handy muss dsm.onehumanwasted.de verwendet werden, da die Kommunikation dort über https läuft und traefik dann an den richtigen Port (2087) verweist.</p><p>Am Computer muss Domain <strong>ohne Cloudflare Proxy</strong> z.b. nasty.onehumanwasted.de verwendet werden, da Cloudlfare Port 6690 und das Drive-Protokoll nicht kann.</p><p>Traefik sollte auf der Domain auch lauschen (traefik horcht ja nur auf 80 443 und 8080) damit Certifikat-Erneuerung funktioniert.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/traefik/'>traefik</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/homelab/" class="post-tag no-text-decoration" >homelab</a> <a href="/tags/dns/" class="post-tag no-text-decoration" >dns</a> <a href="/tags/traefik/" class="post-tag no-text-decoration" >traefik</a> <a href="/tags/portainer/" class="post-tag no-text-decoration" >portainer</a> <a href="/tags/ssl/" class="post-tag no-text-decoration" >ssl</a> <a href="/tags/self-hosted/" class="post-tag no-text-decoration" >self-hosted</a> <a href="/tags/docker/" class="post-tag no-text-decoration" >docker</a> <a href="/tags/loadbalancer/" class="post-tag no-text-decoration" >loadbalancer</a> <a href="/tags/synology/" class="post-tag no-text-decoration" >synology</a> <a href="/tags/crowdsec/" class="post-tag no-text-decoration" >crowdsec</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Traefik loadbalancer with crowdsec Open Source & Collaborative Security - Agrestic Doku&url=https%3A%2F%2Fagrestic1.github.io%2Fposts%2Ftraefik%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Traefik loadbalancer with crowdsec Open Source & Collaborative Security - Agrestic Doku&u=https%3A%2F%2Fagrestic1.github.io%2Fposts%2Ftraefik%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fagrestic1.github.io%2Fposts%2Ftraefik%2F&text=Traefik loadbalancer with crowdsec Open Source & Collaborative Security - Agrestic Doku" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/git/">Git-Fu</a><li><a href="/posts/traefik/">Traefik loadbalancer with crowdsec Open Source & Collaborative Security</a><li><a href="/posts/tdarr-server/">Tdarr server and node configuration to convert Videos to h265</a><li><a href="/posts/docs/">HowTo create documentation site</a><li><a href="/posts/docker/">Docker</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/documentation/">documentation</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/synology/">synology</a> <a class="post-tag" href="/tags/github/">github</a> <a class="post-tag" href="/tags/gitlab/">gitlab</a> <a class="post-tag" href="/tags/website/">website</a> <a class="post-tag" href="/tags/crowdsec/">crowdsec</a> <a class="post-tag" href="/tags/dns/">dns</a> <a class="post-tag" href="/tags/git/">git</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/docs/"><div class="card-body"> <em class="small" data-ts="1654545600" data-df="ll" > Jun 6, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HowTo create documentation site</h3><div class="text-muted small"><p> HowTo create documentation site From: https://docs.technotim.live/posts/jekyll-docs-site/ 📺 Watch Video Install Dependencies sudo apt update sudo apt install ruby-full build-essential zlib1g-dev g...</p></div></div></a></div><div class="card"> <a href="/posts/docker/"><div class="card-body"> <em class="small" data-ts="1654592400" data-df="ll" > Jun 7, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Docker</h3><div class="text-muted small"><p> Docker Installation Install docker: First update sudo apt update &amp;amp;&amp;amp; sudo apt upgrade A) docker.io docker.io does it the Debian (or Ubuntu) way: Each external dependency is a separate pa...</p></div></div></a></div><div class="card"> <a href="/posts/wirehole/"><div class="card-body"> <em class="small" data-ts="1656626400" data-df="ll" > Jul 1, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>WireHole</h3><div class="text-muted small"><p> PiHole und Wireguard Quelle: https://notes.iopush.net/blog/2020/wireguard-and-pi-hole-in-docker/ Wir setzen einen Wireguard server auf. Im selben Docker Nezwerk befindet sich auch ein PiHole Cont...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/docker/" class="btn btn-outline-primary" prompt="Older"><p>Docker</p></a> <a href="/posts/git/" class="btn btn-outline-primary" prompt="Newer"><p>Git-Fu</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/documentation/">documentation</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/synology/">synology</a> <a class="post-tag" href="/tags/github/">github</a> <a class="post-tag" href="/tags/gitlab/">gitlab</a> <a class="post-tag" href="/tags/website/">website</a> <a class="post-tag" href="/tags/crowdsec/">crowdsec</a> <a class="post-tag" href="/tags/dns/">dns</a> <a class="post-tag" href="/tags/git/">git</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/agrestic1">agrestic</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
